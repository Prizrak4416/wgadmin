{% extends "wgadmin/base.html" %}
{% load wg_tags %}
{% block content %}
<div class="flex items-center justify-between">
    <div>
        <div class="text-2xl font-semibold">Clients</div>
        <p class="text-slate-400 text-sm">Source: {{ wg_config_path }}</p>
    </div>
    <button hx-target="#create-form" class="hidden"></button>
    <form method="post" action="{% url 'client-create' %}" class="flex items-end gap-3">
        {% csrf_token %}
        <div>
            <label class="block text-sm text-slate-300 mb-1">Name</label>
            <input id="name-input" name="name" required minlength="3" class="bg-slate-900 border border-slate-800 rounded-lg px-3 py-2 text-sm transition-colors" placeholder="client01">
            <p id="name-error" class="text-xs text-red-400 mt-1 invisible min-h-[1rem]">Введите уникальное имя.</p>
        </div>
        <div>
            <label class="block text-sm text-slate-300 mb-1">Allowed IPs</label>
            <input id="allowed-ips-input" name="allowed_ips" value="0.0.0.0/0" class="bg-slate-900 border border-slate-800 rounded-lg px-3 py-2 text-sm w-48 transition-colors">
            <p id="allowed-ips-error" class="text-xs text-red-400 mt-1 invisible min-h-[1rem]">Этот IP уже используется.</p>
        </div>
        <button id="create-btn" type="submit" class="bg-emerald-500 hover:bg-emerald-400 text-slate-950 font-semibold rounded-lg px-4 py-2 transition-opacity">Create</button>
    </form>
</div>

{{ used_ips|json_script:"used-ips-data" }}
{{ used_names|json_script:"used-names-data" }}

<div class="mt-6 bg-slate-950/60 border border-slate-800 rounded-2xl overflow-hidden">
    <table class="min-w-full">
        <thead class="bg-slate-900/70 text-slate-300 text-sm">
            <tr>
                <th class="px-4 py-3 text-left font-semibold">Name</th>
                <th class="px-4 py-3 text-left font-semibold">Public Key</th>
                <th class="px-4 py-3 text-left font-semibold">Allowed IPs</th>
                <th class="px-4 py-3 text-left font-semibold">Status</th>
                <th class="px-4 py-3 text-left font-semibold">Traffic</th>
                <th class="px-4 py-3 text-left font-semibold">Actions</th>
            </tr>
        </thead>
        <tbody class="divide-y divide-slate-800 text-sm">
            {% for peer in peers %}
                <tr class="hover:bg-slate-900/40">
                    <td class="px-4 py-3 font-semibold">{{ peer.name }}</td>
                    <td class="px-4 py-3 text-slate-300">
                        <div class="font-mono text-xs">{{ peer.public_key|slice:":20" }}...</div>
                    </td>
                    <td class="px-4 py-3 text-slate-300">
                        {{ peer.allowed_ips|join:", " }}
                    </td>
                    <td class="px-4 py-3">
                        {% if peer.is_enabled %}
                            <span class="px-2 py-1 rounded-full bg-emerald-500/20 text-emerald-200 text-xs">Enabled</span>
                        {% else %}
                            <span class="px-2 py-1 rounded-full bg-slate-700 text-slate-200 text-xs">Disabled</span>
                        {% endif %}
                        {% if peer.latest_handshake %}
                            <div class="text-xs text-slate-400">Last handshake {{ peer.latest_handshake }}</div>
                        {% endif %}
                    </td>
                    <td class="px-4 py-3 text-slate-300">
                        {% if peer.transfer_rx %}
                            <div class="text-xs">↓ {{ peer.transfer_rx|filesizeformat }}</div>
                        {% endif %}
                        {% if peer.transfer_tx %}
                            <div class="text-xs">↑ {{ peer.transfer_tx|filesizeformat }}</div>
                        {% endif %}
                    </td>
                    <td class="px-4 py-3">
                        <div class="flex flex-wrap gap-2">
                            <form method="post" action="{% url 'client-activate' peer.identifier %}">
                                {% csrf_token %}
                                <button class="px-3 py-1 rounded-lg bg-cyan-500/80 text-slate-950 text-xs font-semibold hover:bg-cyan-400" type="submit">
                                    Activate
                                </button>
                            </form>
                            {% if peer.is_enabled %}
                                <form method="post" action="{% url 'client-disable' peer.identifier %}">
                                    {% csrf_token %}
                                    <button class="px-3 py-1 rounded-lg bg-amber-500/80 text-slate-950 text-xs font-semibold hover:bg-amber-400" type="submit">
                                        Disable
                                    </button>
                                </form>
                            {% else %}
                                <form method="post" action="{% url 'client-enable' peer.identifier %}">
                                    {% csrf_token %}
                                    <button class="px-3 py-1 rounded-lg bg-emerald-500/80 text-slate-950 text-xs font-semibold hover:bg-emerald-400" type="submit">
                                        Enable
                                    </button>
                                </form>
                            {% endif %}
                            <form method="post" action="{% url 'client-delete' peer.identifier %}" onsubmit="return confirm('Delete {{ peer.name }}?');">
                                {% csrf_token %}
                                <button class="px-3 py-1 rounded-lg bg-red-600/80 text-slate-50 text-xs font-semibold hover:bg-red-500" type="submit">
                                    Delete
                                </button>
                            </form>
                        </div>
                        {% with token=token_map|dict_get:peer.identifier %}
                            {% if token %}
                                {% url 'public-config' token.token as activation_path %}
                                {% with full_url=base_url|add:activation_path %}
                                    <div class="text-xs text-slate-400 mt-2">
                                        Active link until {{ token.expires_at }}<br>
                                        <button
                                            type="button"
                                            class="copy-link break-all text-left text-slate-200 bg-slate-800/30 hover:bg-slate-800/60 hover:text-emerald-200 cursor-pointer transition-colors font-mono px-2 py-1 rounded"
                                            data-url="{{ full_url }}"
                                            aria-label="Copy link">
                                            {{ full_url }}
                                        </button>
                                    </div>
                                {% endwith %}
                            {% endif %}
                        {% endwith %}
                    </td>
                </tr>
            {% empty %}
                <tr>
                    <td colspan="6" class="px-4 py-6 text-center text-slate-400">No peers found in config.</td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
<script>
(() => {
    const usedIpsEl = document.getElementById("used-ips-data");
    const usedNamesEl = document.getElementById("used-names-data");
    if (!usedIpsEl || !usedNamesEl) return;
    const usedIps = JSON.parse(usedIpsEl.textContent || "[]");
    const usedNames = JSON.parse(usedNamesEl.textContent || "[]");
    const input = document.getElementById("allowed-ips-input");
    const error = document.getElementById("allowed-ips-error");
    const submit = document.getElementById("create-btn");
    const nameInput = document.getElementById("name-input");
    const nameError = document.getElementById("name-error");
    if (!input || !error || !submit || !nameInput || !nameError) return;

    const baseClassesIp = input.className;
    const baseClassesName = nameInput.className;

    const hasDuplicateIp = (value) => {
        const ips = value.split(",").map((item) => item.trim()).filter(Boolean);
        return ips.find((ip) => usedIps.includes(ip));
    };

    const updateState = () => {
        const duplicate = hasDuplicateIp(input.value || "");
        const invalid = Boolean(duplicate);
        input.className = invalid
            ? baseClassesIp.replace("border-slate-800", "border-red-500")
            : baseClassesIp;
        error.classList.toggle("invisible", !invalid);
        error.textContent = invalid ? `IP ${duplicate} уже используется.` : "";

        const nameVal = (nameInput.value || "").trim();
        const nameTaken = usedNames.includes(nameVal);
        const nameTooShort = nameVal.length > 0 && nameVal.length < 3;
        const nameInvalid = nameTaken || !nameVal || nameTooShort;
        nameInput.className = nameInvalid
            ? baseClassesName.replace("border-slate-800", "border-red-500")
            : baseClassesName;
        if (!nameVal) {
            nameError.textContent = "Имя не может быть пустым.";
        } else if (nameTooShort) {
            nameError.textContent = "Имя должно быть не короче 3 символов.";
        } else if (nameTaken) {
            nameError.textContent = `Имя ${nameVal} уже используется.`;
        }
        nameError.classList.toggle("invisible", !nameInvalid);

        const isDisabled = invalid || nameInvalid;
        submit.disabled = isDisabled;
        submit.classList.toggle("opacity-50", isDisabled);
        submit.classList.toggle("cursor-not-allowed", isDisabled);
    };

    input.addEventListener("input", updateState);
    nameInput.addEventListener("input", updateState);
    updateState();
})();

(() => {
    const copyButtons = document.querySelectorAll(".copy-link");
    if (!copyButtons.length) return;

    const copyToClipboard = async (text) => {
        try {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                await navigator.clipboard.writeText(text);
                return true;
            }
        } catch (e) {
            // fall back below
        }
        const textarea = document.createElement("textarea");
        textarea.value = text;
        textarea.style.position = "fixed";
        textarea.style.opacity = "0";
        document.body.appendChild(textarea);
        textarea.focus();
        textarea.select();
        try {
            document.execCommand("copy");
            document.body.removeChild(textarea);
            return true;
        } catch (err) {
            document.body.removeChild(textarea);
            return false;
        }
    };

    copyButtons.forEach((btn) => {
        btn.addEventListener("click", async () => {
            const url = btn.dataset.url || btn.textContent || "";
            const ok = await copyToClipboard(url.trim());
            if (ok) {
                const original = btn.textContent;
                btn.textContent = "Copied!";
                btn.classList.add("text-emerald-300");
                setTimeout(() => {
                    btn.textContent = original;
                    btn.classList.remove("text-emerald-300");
                }, 1200);
            }
        });
    });
})();
</script>
{% endblock %}
